{% extends "base.html" %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}

<!-- Search bar -->
<div class="mb-3">
  <form method="get" action="{% url 'index' %}">
    <input type="text" name="search" class="form-control" placeholder="Search posts..." value="{{ query }}">
  </form>
</div>

<!-- Posts -->
<div class="posts">
  {% for post in posts %}
  <div class="row post-one border rounded-3 shadow-sm p-3 mb-4 bg-white">

    <!-- Avatar -->
    <div class="col-1 d-flex justify-content-center">
      {% if post.user.profile %}
        <img class="rounded-circle avatar"
             src="{{ post.user.profile.url }}"
             alt="Profile picture">
      {% else %}
        <img class="rounded-circle avatar"
             src="{% static 'images/default.jpg' %}"
             alt="Default profile picture">
      {% endif %}
    </div>

    <!-- Post content -->
    <div class="col-11">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ post.user.username }}</strong>
          <small class="text-muted">@{{ post.user.username }}</small>
        </div>
        <small class="text-muted">{{ post.created_at|date:"M d, Y H:i" }}</small>
      </div>

      <!-- Body link to detail -->
      <p class="mt-2 mb-2">
        <a href="{% url 'post_detail' post.id %}" class="text-decoration-none text-dark">
          {{ post.body|truncatewords:20 }}
        </a>
      </p>

      <!-- Image link to detail -->
      {% if post.media %}
        <a href="{% url 'post_detail' post.id %}">
          <img src="{{ post.media.url }}" alt="Post media" class="post-image mt-2">
        </a>
      {% endif %}

      <!-- Actions -->
      <div class="d-flex justify-content-between mt-3 text-muted">
        <div class="action small">
          <i class="fa-regular fa-comment"></i> {{ post.comments.count }}
        </div>
        <div class="action small">
          <a href="{% url 'post_like' post.id %}" class="text-decoration-none">
            {% if user in post.likes.all %}
              <i class="fa-solid fa-heart text-danger"></i>
            {% else %}
              <i class="fa-regular fa-heart"></i>
            {% endif %}
            {{ post.likes.count }}
          </a>
        </div>
        <div class="action small">
          <i class="fa-regular fa-bookmark"></i> {{ post.saveds.count }}
        </div>
      </div>

      <!-- Comments (last 3) -->
      <div class="comments mt-3">
        {% for comment in post.comments.all|dictsortreversed:"created"|slice:":3" %}
          <p class="mb-1">
            <strong>{{ comment.user.username }}</strong>:
            {{ comment.body }}
          </p>
        {% empty %}
          <p class="text-muted small">No comments yet.</p>
        {% endfor %}

        <!-- Add Comment Form -->
        <form method="post" action="{% url 'add_comment' post.id %}" class="mt-2">
          {% csrf_token %}
          <div class="input-group">
            <input type="text" name="body" class="form-control" placeholder="Write a comment...">
            <button class="btn btn-outline-primary" type="submit">Send</button>
          </div>
        </form>
      </div>

    </div>
  </div>
  {% empty %}
  <p class="text-center text-muted">No posts yet.</p>
  {% endfor %}
</div>

{% endblock %}
